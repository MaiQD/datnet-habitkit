@page "/settings"
@using HabitKitClone.Services
@using HabitKitClone.Resources
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Localization
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<SharedResource> Localizer
@inject NavigationManager NavigationManager
@inject IUserSettingsService UserSettingsService
@inject UserContextService UserContext
@inject IJSRuntime JSRuntime
@attribute [Authorize]

<PageTitle>@Localizer["Settings"]</PageTitle>

<div class="page-container">
    <!-- Header -->
    <header class="app-header">
        <div class="header-left">
            <button class="icon-button" aria-label="Back" @onclick="NavigateToHome">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="header-center">
            <h1 class="app-title">@Localizer["Settings"]</h1>
        </div>
        <div class="header-right">
            <!-- Empty for balance -->
        </div>
    </header>

    <!-- Subscribe to Pro Banner -->
    <div class="pro-banner">
        <div class="pro-banner-content">
            <div class="pro-icon">
                <div class="pro-icon-grid">
                    <div class="grid-square green"></div>
                    <div class="grid-square purple"></div>
                    <div class="grid-square orange"></div>
                    <div class="grid-square red"></div>
                </div>
            </div>
            <div class="pro-text">
                <h3>Subscribe to <strong>HabitKit Pro</strong></h3>
                <p>Unlimited habits, import/export data, advanced analytics, and more</p>
            </div>
            <div class="pro-arrow">
                <i class="fas fa-chevron-right"></i>
            </div>
        </div>
    </div>

    <!-- Settings Sections -->
    <div class="settings-sections">
        <!-- App Section -->
        <div class="settings-section">
            <h4 class="section-title">App</h4>
            <div class="settings-list">
                <div class="settings-item" @onclick="NavigateToGeneral">
                    <div class="settings-item-left">
                        <div class="settings-icon pink">
                            <i class="fas fa-cog"></i>
                        </div>
                        <span class="settings-label">General</span>
                    </div>
                    <i class="fas fa-chevron-right settings-arrow"></i>
                </div>
                
                <div class="settings-item" @onclick="NavigateToReminders">
                    <div class="settings-item-left">
                        <div class="settings-icon blue">
                            <i class="fas fa-bell"></i>
                        </div>
                        <span class="settings-label">Daily Check-In Reminders</span>
                    </div>
                    <i class="fas fa-chevron-right settings-arrow"></i>
                </div>
                
                <div class="settings-item" @onclick="ToggleTheme">
                    <div class="settings-item-left">
                        <div class="settings-icon orange">
                            <i class="fas fa-palette"></i>
                        </div>
                        <span class="settings-label">Theme</span>
                    </div>
                    <div class="settings-toggle">
                        <div class="toggle @(currentTheme == "dark" ? "active" : "")" @onclick="ToggleTheme">
                            <div class="toggle-handle"></div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-item" @onclick="NavigateToArchived">
                    <div class="settings-item-left">
                        <div class="settings-icon green">
                            <i class="fas fa-archive"></i>
                        </div>
                        <span class="settings-label">Archived Habits</span>
                    </div>
                    <i class="fas fa-chevron-right settings-arrow"></i>
                </div>
                
                <div class="settings-item" @onclick="NavigateToImportExport">
                    <div class="settings-item-left">
                        <div class="settings-icon blue">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <span class="settings-label">Data Import/Export</span>
                    </div>
                    <i class="fas fa-chevron-right settings-arrow"></i>
                </div>
                
                <div class="settings-item" @onclick="NavigateToReorder">
                    <div class="settings-item-left">
                        <div class="settings-icon red">
                            <i class="fas fa-sort"></i>
                        </div>
                        <span class="settings-label">Reorder Habits</span>
                    </div>
                    <i class="fas fa-chevron-right settings-arrow"></i>
                </div>
            </div>
        </div>

        <!-- Help Section -->
        <div class="settings-section">
            <h4 class="section-title">Help</h4>
            <div class="settings-list">
                <div class="settings-item" @onclick="ShowOnboarding">
                    <div class="settings-item-left">
                        <div class="settings-icon orange">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <span class="settings-label">Show Onboarding</span>
                    </div>
                    <i class="fas fa-chevron-right settings-arrow"></i>
                </div>
                
                <div class="settings-item" @onclick="ShowWhatsNew">
                    <div class="settings-item-left">
                        <div class="settings-icon blue">
                            <i class="fas fa-star"></i>
                        </div>
                        <span class="settings-label">Show What's New</span>
                    </div>
                    <i class="fas fa-chevron-right settings-arrow"></i>
                </div>
                
                <div class="settings-item" @onclick="SendFeedback">
                    <div class="settings-item-left">
                        <div class="settings-icon gray">
                            <i class="fas fa-paper-plane"></i>
                        </div>
                        <span class="settings-label">Send feedback</span>
                    </div>
                    <i class="fas fa-chevron-right settings-arrow"></i>
                </div>
            </div>
        </div>

        <!-- About Section -->
        <div class="settings-section">
            <h4 class="section-title">About</h4>
            <div class="settings-list">
                <div class="settings-item" @onclick="OpenWebsite">
                    <div class="settings-item-left">
                        <div class="settings-icon green">
                            <i class="fas fa-globe"></i>
                        </div>
                        <span class="settings-label">Website</span>
                    </div>
                    <i class="fas fa-chevron-right settings-arrow"></i>
                </div>
                
                <div class="settings-item" @onclick="OpenTwitter">
                    <div class="settings-item-left">
                        <div class="settings-icon blue">
                            <i class="fab fa-twitter"></i>
                        </div>
                        <span class="settings-label">Follow on X</span>
                    </div>
                    <i class="fas fa-chevron-right settings-arrow"></i>
                </div>
                
                <div class="settings-item" @onclick="OpenPrivacyPolicy">
                    <div class="settings-item-left">
                        <div class="settings-icon pink">
                            <i class="fas fa-lock"></i>
                        </div>
                        <span class="settings-label">Privacy Policy</span>
                    </div>
                    <i class="fas fa-chevron-right settings-arrow"></i>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string currentTheme = "dark";

    protected override async Task OnInitializedAsync()
    {
        var userId = await UserContext.GetCurrentUserIdAsync();
        if (!string.IsNullOrEmpty(userId))
        {
            var settings = await UserSettingsService.GetUserSettingsAsync(userId);
            if (settings != null)
            {
                currentTheme = settings.Theme;
            }
        }
    }

    private void NavigateToHome()
    {
        NavigationManager.NavigateTo("/");
    }

    private async Task ToggleTheme()
    {
        currentTheme = currentTheme == "dark" ? "light" : "dark";
        
        var userId = await UserContext.GetCurrentUserIdAsync();
        if (!string.IsNullOrEmpty(userId))
        {
            await UserSettingsService.UpdateThemeAsync(userId, currentTheme);
            await JSRuntime.InvokeVoidAsync("setCookie", "theme", currentTheme, 365);
            await JSRuntime.InvokeVoidAsync("applyTheme", currentTheme);
        }
        
        StateHasChanged();
    }

    private void NavigateToGeneral()
    {
        // TODO: Implement general settings page
        Console.WriteLine("Navigate to General settings");
    }

    private void NavigateToReminders()
    {
        // TODO: Implement reminders settings
        Console.WriteLine("Navigate to Reminders settings");
    }

    private void NavigateToArchived()
    {
        // TODO: Implement archived habits page
        Console.WriteLine("Navigate to Archived habits");
    }

    private void NavigateToImportExport()
    {
        // TODO: Implement import/export page
        Console.WriteLine("Navigate to Import/Export");
    }

    private void NavigateToReorder()
    {
        // TODO: Implement reorder habits page
        Console.WriteLine("Navigate to Reorder habits");
    }

    private void ShowOnboarding()
    {
        // TODO: Implement onboarding flow
        Console.WriteLine("Show onboarding");
    }

    private void ShowWhatsNew()
    {
        // TODO: Implement what's new modal
        Console.WriteLine("Show what's new");
    }

    private void SendFeedback()
    {
        // TODO: Implement feedback form
        Console.WriteLine("Send feedback");
    }

    private void OpenWebsite()
    {
        // TODO: Open website in browser
        Console.WriteLine("Open website");
    }

    private void OpenTwitter()
    {
        // TODO: Open Twitter profile
        Console.WriteLine("Open Twitter");
    }

    private void OpenPrivacyPolicy()
    {
        // TODO: Open privacy policy
        Console.WriteLine("Open privacy policy");
    }
}
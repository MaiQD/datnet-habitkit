@using Microsoft.Extensions.Localization
@using HabitKitClone.Resources

<div class="contribution-chart" role="img" aria-label="Habit contribution chart for the past year">
    <div class="chart-container">
        <div class="chart-grid">
            @{
                var weeks = Data.GroupBy(d => GetWeekOfYear(d.Date)).OrderBy(g => g.Key).ToList();
            }
            
            @for (int week = 0; week < 53; week++)
            {
                <div class="chart-week">
                    @{
                        var weekData = weeks.FirstOrDefault(w => w.Key == week)?.ToList() ?? new List<ContributionDay>();
                        var daysInWeek = 7;
                    }
                    
                    @for (int day = 0; day < daysInWeek; day++)
                    {
                        var dayData = weekData.FirstOrDefault(d => (int)d.Date.DayOfWeek == day);
                        var level = dayData?.Level ?? 0;
                        var opacity = GetOpacityForLevel(level);
                        
                        <div class="chart-cell level-@level"
                             style="background-color: @Color; opacity: @opacity;"
                             title="@(dayData?.Date.ToString("MMM dd, yyyy") ?? "")"
                             role="button"
                             tabindex="0"
                             @onclick="() => OnCellClick.InvokeAsync(dayData)"
                             @onkeypress="@(async (e) => { if (e.Key == "Enter" || e.Key == " ") { await OnCellClick.InvokeAsync(dayData); } })">
                        </div>
                    }
                </div>
            }
        </div>
    </div>
    
    <div class="chart-legend">
        <span class="legend-text">Less</span>
        <div class="legend-cells">
            @for (int i = 0; i < 5; i++)
            {
                <div class="legend-cell level-@i" style="background-color: @Color; opacity: @GetOpacityForLevel(i)"></div>
            }
        </div>
        <span class="legend-text">More</span>
    </div>
</div>

@code {
    [Parameter] public List<ContributionDay> Data { get; set; } = new();
    [Parameter] public string Color { get; set; } = "#238636";
    [Parameter] public int HabitId { get; set; }
    [Parameter] public EventCallback<ContributionDay?> OnCellClick { get; set; }

    private int GetWeekOfYear(DateTime date)
    {
        var calendar = System.Globalization.CultureInfo.CurrentCulture.Calendar;
        return calendar.GetWeekOfYear(date, System.Globalization.CalendarWeekRule.FirstDay, DayOfWeek.Sunday);
    }

    private double GetOpacityForLevel(int level)
    {
        return level switch
        {
            0 => 0.1,
            1 => 0.3,
            2 => 0.5,
            3 => 0.7,
            4 => 1.0,
            _ => 0.1
        };
    }
}

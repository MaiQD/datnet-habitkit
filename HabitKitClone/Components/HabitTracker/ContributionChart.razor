@using Microsoft.Extensions.Localization
@using Microsoft.AspNetCore.Components.Web
@using HabitKitClone.Resources
@inject IJSRuntime JSRuntime
@inject IStringLocalizer<SharedResource> Localizer

<div class="contribution-chart" role="img" aria-label="Habit contribution chart for the past year">
    <div class="chart-wrapper">
        <div class="chart-container" @ref="chartContainer">
            <div class="chart-grid">
                @{
                    var weeks = Data.GroupBy(d => GetWeekOfYear(d.Date)).OrderBy(g => g.Key).ToList();
                }
                
                @for (int day = 0; day < 7; day++)
                {
                    var dayName = GetDayName(day);
                    <div class="chart-row">
                        <div class="day-label">@Localizer[dayName]</div>
                        <div class="day-cells">
                            @for (int week = 0; week < 53; week++)
                            {
                                var weekData = weeks.FirstOrDefault(w => w.Key == week)?.ToList() ?? new List<ContributionDay>();
                                var dayData = weekData.FirstOrDefault(d => (int)d.Date.DayOfWeek == day);
                                var count = dayData?.Count ?? 0;
                                var opacity = GetOpacityForCount(count);
                                
                                <div class="chart-cell"
                                     style="background-color: @(string.IsNullOrEmpty(Color) ? "#238636" : Color) !important; opacity: @opacity !important;"
                                     title="@(dayData != null ? $"{dayData.Date:MMM dd, yyyy} - {count} completion{(count != 1 ? "s" : "")}" : "")"
                                     role="button"
                                     tabindex="0"
                                     @onclick="() => OnCellClick.InvokeAsync(dayData)"
                                     @onkeypress="@(async (e) => { if (e.Key == "Enter" || e.Key == " ") { await OnCellClick.InvokeAsync(dayData); } })">
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    [Parameter] public List<ContributionDay> Data { get; set; } = new();
    [Parameter] public string Color { get; set; } = "#238636";
    [Parameter] public int HabitId { get; set; }
    [Parameter] public EventCallback<ContributionDay?> OnCellClick { get; set; }

    private ElementReference chartContainer;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ScrollToCurrentDay();
        }
    }

    private async Task ScrollToCurrentDay()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("scrollChartToEnd", chartContainer);
        }
        catch
        {
            // Ignore JS errors - chart will still work without auto-scroll
        }
    }

    private string GetDayName(int dayOfWeek)
    {
        return dayOfWeek switch
        {
            0 => "Sun",
            1 => "Mon", 
            2 => "Tue",
            3 => "Wed",
            4 => "Thu",
            5 => "Fri",
            6 => "Sat",
            _ => "Sun"
        };
    }

    private int GetWeekOfYear(DateTime date)
    {
        var calendar = System.Globalization.CultureInfo.CurrentCulture.Calendar;
        return calendar.GetWeekOfYear(date, System.Globalization.CalendarWeekRule.FirstDay, DayOfWeek.Sunday);
    }

    private double GetOpacityForCount(int count)
    {
        return count switch
        {
            0 => 0.0,  // Completely transparent for empty cells
            1 => 0.4,  // Light opacity for single completion
            2 => 0.5,  // Medium opacity for 2 completions
            3 => 0.6,  // Medium-high opacity for 3 completions
            4 => 0.7,  // High opacity for 4 completions
            5 => 0.8,  // Very high opacity for 5 completions
            6 => 0.8,  // Very high opacity for 6 completions
            7 => 0.9,  // Almost full opacity for 7 completions
            8 => 0.9,  // Almost full opacity for 8 completions
            9 => 0.9,  // Almost full opacity for 9 completions
            _ => 1.0   // Full opacity for 10+ completions
        };
    }
}